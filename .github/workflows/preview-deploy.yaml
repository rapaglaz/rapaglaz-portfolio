name: Preview Deploy

on:
  workflow_run:
    workflows: ['Pull Request Checks']
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@fa0b91b0dee0290e335901f196a338e367e94627 # v4
        with:
          name: build-artifact-pr
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR Number
        id: pr-number
        run: |
          if [ "${{ github.event.workflow_run.event }}" == "pull_request" ]; then
            # Try to get PR number from the triggering workflow run
            PR_NUMBER=$(gh api "repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" | jq -r '.pull_requests[0].number')
          fi

          if [ "$PR_NUMBER" == "null" ] || [ -z "$PR_NUMBER" ]; then
            # Fallback: find PR by head branch
            PR_NUMBER=$(gh pr list --head "${{ github.event.workflow_run.head_branch }}" --format json -q '.[0].number' --limit 1)
          fi

          if [ "$PR_NUMBER" == "null" ] || [ -z "$PR_NUMBER" ]; then
             echo "Error: Could not determine PR number"
             exit 1
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GH Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .
          target-folder: previews/pr-${{ steps.pr-number.outputs.PR_NUMBER }}
          branch: gh-pages
          clean: false # Do not delete other previews
          commit-message: 'docs: deploy preview for PR #${{ steps.pr-number.outputs.PR_NUMBER }}'
          single-commit: false # Keep history for cleanup to work better if needed, but not strictly required

      - name: Comment PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ steps.pr-number.outputs.PR_NUMBER }}
          header: preview-url
          message: |
            ## PR Preview Ready!

            You can view the changes at:
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/previews/pr-${{ steps.pr-number.outputs.PR_NUMBER }}/
