name: Pull Request Checks

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    outputs:
      app: ${{ steps.filter.outputs.app }}
      e2e: ${{ steps.filter.outputs.e2e }}
      i18n: ${{ steps.filter.outputs.i18n }}
      ci: ${{ steps.filter.outputs.ci }}
      deps: ${{ steps.filter.outputs.deps }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect changed file paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            app:
              - 'src/**'
              - 'public/**'
              - 'angular.json'
              - 'tsconfig*.json'
              - 'eslint.config.mjs'
              - '.lighthouserc.cjs'
            e2e:
              - 'e2e/**/*.ts'
              - 'playwright.config.*'
            i18n:
              - 'public/i18n/**'
            ci:
              - '.github/workflows/**'
              - '.github/actions/**'
            deps:
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - '.npmrc'

  quality-check:
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.app == 'true' || needs.detect-changes.outputs.i18n == 'true' || needs.detect-changes.outputs.deps == 'true' }}
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Run Quality Check
        uses: ./.github/actions/quality-check
        with:
          run-tests: ${{ needs.detect-changes.outputs.app == 'true' }}
          run-i18n-check: ${{ needs.detect-changes.outputs.app == 'true' || needs.detect-changes.outputs.i18n == 'true' }}
          only-i18n: ${{ needs.detect-changes.outputs.i18n == 'true' && needs.detect-changes.outputs.app != 'true' && needs.detect-changes.outputs.e2e != 'true' && needs.detect-changes.outputs.ci != 'true' && needs.detect-changes.outputs.deps != 'true' }}
          coverage-artifact-name: coverage-reports
          coverage-retention-days: '3'
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-extra-args: >
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.newCode.referenceBranch=main

  workflow-lint:
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.ci == 'true' || (needs.detect-changes.outputs.app != 'true' && needs.detect-changes.outputs.i18n != 'true' && needs.detect-changes.outputs.e2e != 'true' && needs.detect-changes.outputs.deps != 'true') }}
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Run actionlint
        shell: bash
        run: |
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash) 1.7.11
          ./actionlint -color

  e2e-tests:
    needs: [detect-changes, build]
    if: ${{ needs.detect-changes.outputs.app == 'true' || needs.detect-changes.outputs.e2e == 'true' }}
    permissions:
      contents: read
      statuses: write
    uses: ./.github/workflows/e2e.yaml
    with:
      checkout-ref: ${{ github.event.pull_request.head.sha }}
      build-artifact-name: build-artifact-pr
      report-artifact-name: playwright-report-pr
      report-retention-days: 3

  build:
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.app == 'true' || needs.detect-changes.outputs.i18n == 'true' || needs.detect-changes.outputs.e2e == 'true' || needs.detect-changes.outputs.deps == 'true' }}
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Build application
        uses: ./.github/actions/build

      - name: Upload build artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: build-artifact-pr
          path: dist/rapaglaz-portfolio/browser
          retention-days: 1

  lighthouse:
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: ${{ needs.detect-changes.outputs.app == 'true' }}
    continue-on-error: true
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: build-artifact-pr
          path: dist/rapaglaz-portfolio/browser

      - name: Setup environment
        uses: ./.github/actions/workspace-setup

      - name: Run Lighthouse report
        uses: ./.github/actions/lighthouse/report
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  deploy-preview:
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: >
      github.event_name == 'pull_request' &&
      needs.build.result == 'success' &&
      (needs.detect-changes.outputs.app == 'true' || needs.detect-changes.outputs.i18n == 'true')
    permissions:
      contents: write
      pages: write
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: build-artifact-pr
          path: build-output

      - name: Deploy preview
        uses: ./.github/actions/deploy-preview
        with:
          repo-name: ${{ github.event.repository.name }}
          repo-owner: ${{ github.repository_owner }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-updated-at: ${{ github.event.pull_request.updated_at }}
          gh-pages-token: ${{ secrets.GH_PAGES_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
