name: Lighthouse CI

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 6 * * 1' # Every Monday at 6:00 AM

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup environment
        uses: ./.github/actions/workspace-setup-action

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.15.x

      - name: Ensure Playwright browsers are installed
        run: pnpm exec playwright install chromium

      - name: Find Chrome executable path
        id: chrome
        run: |
          # Find Playwright's Chromium executable
          CHROME_PATH=$(pnpm exec playwright chromium --version 2>&1 | grep -o '/.*chromium.*/chrome' | head -1)
          if [ -z "$CHROME_PATH" ]; then
            # Fallback: search in common Playwright locations
            if [ -d "$HOME/.cache/ms-playwright" ]; then
              CHROME_PATH=$(find "$HOME/.cache/ms-playwright" -name "chrome" -o -name "chromium" | grep -E "chrome$|chromium$" | head -1)
            fi
          fi
          echo "Chrome path: $CHROME_PATH"
          echo "path=$CHROME_PATH" >> $GITHUB_OUTPUT

      - name: Build application
        run: pnpm run build

      - name: Run Lighthouse CI
        run: lhci autorun --config=.lighthouserc.cjs
        env:
          CHROME_PATH: ${{ steps.chrome.outputs.path }}
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Format results for PR comment
        if: github.event_name == 'pull_request'
        id: format
        run: |
          # Extract results from the latest run
          if [ -f ".lighthouseci/manifest.json" ]; then
            # Get the public URL from links.json (if using temporary-public-storage)
            public_url=$(cat .lighthouseci/links.json 2>/dev/null | grep -o 'https://[^"]*' | head -1 || echo "")

            # Extract scores from the latest report
            latest_report=$(ls -t .lighthouseci/lhr-*.json 2>/dev/null | head -1)
            if [ -f "$latest_report" ]; then
              perf=$(jq '.categories.performance.score * 100 | round' "$latest_report")
              a11y=$(jq '.categories.accessibility.score * 100 | round' "$latest_report")
              bp=$(jq '.categories["best-practices"].score * 100 | round' "$latest_report")
              seo=$(jq '.categories.seo.score * 100 | round' "$latest_report")

              echo "performance=$perf" >> $GITHUB_OUTPUT
              echo "accessibility=$a11y" >> $GITHUB_OUTPUT
              echo "best_practices=$bp" >> $GITHUB_OUTPUT
              echo "seo=$seo" >> $GITHUB_OUTPUT
              echo "public_url=$public_url" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          header: lighthouse
          message: |
            ## âš¡ Lighthouse CI Results

            | Category | Score |
            |----------|-------|
            | ğŸš€ Performance | ${{ steps.format.outputs.performance }}/100 |
            | â™¿ Accessibility | ${{ steps.format.outputs.accessibility }}/100 |
            | âœ… Best Practices | ${{ steps.format.outputs.best_practices }}/100 |
            | ğŸ” SEO | ${{ steps.format.outputs.seo }}/100 |

            ${{ steps.format.outputs.public_url && format('ğŸ“Š [View Full Report]({0})', steps.format.outputs.public_url) || '' }}

            <details>
            <summary>Details</summary>

            - **Commit**: [${{ github.event.pull_request.head.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.event.pull_request.head.sha }})
            - **Build**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Runs**: 3 (averaged)
            </details>

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: lighthouse-reports-${{ github.event_name }}-${{ github.run_number }}
          path: .lighthouseci/
          retention-days: 30
