name: Lighthouse CI

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 6 * * 1' # Every Monday at 6:00 AM

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      source: ${{ steps.filter.outputs.source }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Detect changed file paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            source:
              - 'src/**'
              - 'public/**'
              - 'angular.json'
              - '.lighthouserc.cjs'

  lighthouse:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.source == 'true' }}
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup environment
        uses: ./.github/actions/workspace-setup-action

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.15.x

      - name: Build application
        run: pnpm run build

      - name: Run Lighthouse CI
        run: lhci autorun --config=.lighthouserc.cjs
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Format results for PR comment
        if: github.event_name == 'pull_request'
        id: format
        run: |
          # Get the public URL from links.json
          # links.json format: {"http://localhost:4233/": "https://storage.googleapis.com/..."}
          if [ -f ".lighthouseci/links.json" ]; then
            public_url=$(jq -r 'to_entries[0].value // empty' .lighthouseci/links.json 2>/dev/null || echo "")
            echo "Found public URL: $public_url"
          else
            echo "Warning: .lighthouseci/links.json not found"
            public_url=""
          fi

          # Find the most recent LHR report file
          latest_report=$(find .lighthouseci -name 'lhr-*.json' -type f -print0 2>/dev/null | xargs -0 ls -t 2>/dev/null | head -1)

          if [ -n "$latest_report" ] && [ -f "$latest_report" ]; then
            # Extract scores
            perf=$(jq -r '(.categories.performance.score * 100) | round' "$latest_report")
            a11y=$(jq -r '(.categories.accessibility.score * 100) | round' "$latest_report")
            bp=$(jq -r '(.categories["best-practices"].score * 100) | round' "$latest_report")
            seo=$(jq -r '(.categories.seo.score * 100) | round' "$latest_report")

            echo "Extracted scores: perf=$perf, a11y=$a11y, bp=$bp, seo=$seo"

            # Generate pass/fail status based on thresholds
            get_status() {
              score=$1
              threshold=$2
              if [ "$score" -ge "$threshold" ]; then echo "âœ…"
              else echo "âš ï¸"
              fi
            }

            perf_status=$(get_status "$perf" 80)
            a11y_status=$(get_status "$a11y" 90)
            bp_status=$(get_status "$bp" 80)
            seo_status=$(get_status "$seo" 90)

            # A11y specific status with text
            if [ "$a11y" -ge 90 ]; then
              a11y_pass="âœ… PASS"
            else
              a11y_pass="âš ï¸ BELOW THRESHOLD"
            fi

            # Output results
            {
              echo "performance=$perf"
              echo "accessibility=$a11y"
              echo "best_practices=$bp"
              echo "seo=$seo"
              echo "perf_status=$perf_status"
              echo "a11y_status=$a11y_status"
              echo "bp_status=$bp_status"
              echo "seo_status=$seo_status"
              echo "a11y_pass=$a11y_pass"
              echo "public_url=$public_url"
            } >> "$GITHUB_OUTPUT"

            echo "Results written to GITHUB_OUTPUT"
          else
            echo "Error: No LHR report found"
            exit 1
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          header: lighthouse
          message: |
            ## Lighthouse CI Results

            ### â™¿ Accessibility Score

            | Score | Status | Threshold |
            |:-----:|:------:|:---------:|
            | **${{ steps.format.outputs.accessibility }}%** | ${{ steps.format.outputs.a11y_pass }} | â‰¥ 90% |

            ### All Categories

            | Category | Score | Status |
            |----------|:-----:|:------:|
            | Performance | **${{ steps.format.outputs.performance }}%** | ${{ steps.format.outputs.perf_status }} |
            | Accessibility | **${{ steps.format.outputs.accessibility }}%** | ${{ steps.format.outputs.a11y_status }} |
            | Best Practices | **${{ steps.format.outputs.best_practices }}%** | ${{ steps.format.outputs.bp_status }} |
            | SEO | **${{ steps.format.outputs.seo }}%** | ${{ steps.format.outputs.seo_status }} |

            > **Thresholds:** Performance â‰¥80%, Accessibility â‰¥90%, Best Practices â‰¥80%, SEO â‰¥90%

            ${{ steps.format.outputs.public_url && format('ðŸ”— **[View Full Lighthouse Report â†’]({0})**', steps.format.outputs.public_url) || '' }}

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: lighthouse-reports-${{ github.event_name }}-${{ github.run_number }}
          path: .lighthouseci/
          retention-days: 14
