name: Lighthouse CI

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 6 * * 1' # Every Monday at 6:00 AM

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup environment
        uses: ./.github/actions/workspace-setup-action

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.15.x

      - name: Build application
        run: pnpm run build

      - name: Run Lighthouse CI
        run: lhci autorun --config=.lighthouserc.cjs
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Format results for PR comment
        if: github.event_name == 'pull_request'
        id: format
        run: |
          # Get the public URL from links.json
          # links.json format: {"http://localhost:4233/": "https://storage.googleapis.com/..."}
          if [ -f ".lighthouseci/links.json" ]; then
            public_url=$(jq -r 'to_entries[0].value // empty' .lighthouseci/links.json 2>/dev/null || echo "")
            echo "Found public URL: $public_url"
          else
            echo "Warning: .lighthouseci/links.json not found"
            public_url=""
          fi

          # Find the most recent LHR report file
          latest_report=$(ls -t .lighthouseci/lhr-*.json 2>/dev/null | head -1)

          if [ -n "$latest_report" ] && [ -f "$latest_report" ]; then
            # Extract scores
            perf=$(jq -r '(.categories.performance.score * 100) | round' "$latest_report")
            a11y=$(jq -r '(.categories.accessibility.score * 100) | round' "$latest_report")
            bp=$(jq -r '(.categories["best-practices"].score * 100) | round' "$latest_report")
            seo=$(jq -r '(.categories.seo.score * 100) | round' "$latest_report")

            echo "Extracted scores: perf=$perf, a11y=$a11y, bp=$bp, seo=$seo"

            # Generate score badges with colors
            get_badge() {
              score=$1
              if [ "$score" -ge 90 ]; then echo "ðŸŸ¢"
              elif [ "$score" -ge 50 ]; then echo "ðŸŸ¡"
              else echo "ðŸ”´"
              fi
            }

            perf_badge=$(get_badge $perf)
            a11y_badge=$(get_badge $a11y)
            bp_badge=$(get_badge $bp)
            seo_badge=$(get_badge $seo)

            # Output results
            {
              echo "performance=$perf"
              echo "accessibility=$a11y"
              echo "best_practices=$bp"
              echo "seo=$seo"
              echo "perf_badge=$perf_badge"
              echo "a11y_badge=$a11y_badge"
              echo "bp_badge=$bp_badge"
              echo "seo_badge=$seo_badge"
              echo "public_url=$public_url"
            } >> $GITHUB_OUTPUT

            echo "Results written to GITHUB_OUTPUT"
          else
            echo "Error: No LHR report found"
            exit 1
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          header: lighthouse
          message: |
            ## Lighthouse CI Results

            | Category            | Score |
            |---------------------|------:|
            | **Performance**     | **${{ steps.format.outputs.performance }}%** |
            | **Accessibility**   | **${{ steps.format.outputs.accessibility }}%** |
            | **Best Practices**  | **${{ steps.format.outputs.best_practices }}%** |
            | **SEO**             | **${{ steps.format.outputs.seo }}%** |

            ${{ steps.format.outputs.public_url && format('**[View Full Lighthouse Report â†’]({0})**', steps.format.outputs.public_url) || '' }}

            <details>
            <summary>Details</summary>

            - **Commit:** [${{ github.event.pull_request.head.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.event.pull_request.head.sha }})
            - **Build:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Tested:** 3 runs (median score shown)
            - **Environment:** Desktop

            </details>

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: lighthouse-reports-${{ github.event_name }}-${{ github.run_number }}
          path: .lighthouseci/
          retention-days: 14
